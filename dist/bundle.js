/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/game.ts":
/*!*********************!*\
  !*** ./src/game.ts ***!
  \*********************/
/***/ (function(__unused_webpack_module, exports) {

eval("\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        if (typeof b !== \"function\" && b !== null)\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nexports.__esModule = true;\nexports.cellTypeFromNumber = exports.Building = exports.CellType = exports.Cell = exports.World = void 0;\nvar CellType = Object.freeze({\n    Empty: Symbol(\"Empty\"),\n    ResidentialBuilding: Symbol(\"ResidentialBuilding\"),\n    Road: Symbol(\"Road\"),\n    Factory: Symbol(\"Factory\"),\n    Shop: Symbol(\"Shop\"),\n    Storage: Symbol(\"Storage\"),\n    CityDecor: Symbol(\"CityDecor\")\n});\nexports.CellType = CellType;\nfunction cellTypeFromNumber(arr) {\n    var num = arr[0] * 12 + arr[1];\n    return num == 0 ? CellType.Empty\n        : [47, 71].includes(num) ? CellType.Storage\n            : [46, 54, 56, 66, 69].includes(num) ? CellType.Shop\n                : [1, 48, 49, 50, 51, 52, 53].includes(num) ? CellType.CityDecor\n                    : [64, 65, 68].includes(num) ? CellType.Factory\n                        : num < 54 ? CellType.Road\n                            : CellType.ResidentialBuilding;\n}\nexports.cellTypeFromNumber = cellTypeFromNumber;\nvar World = (function () {\n    function World(map) {\n        this.map = map;\n    }\n    World.fromTextureArray = function (arr) {\n        var newArr = [];\n        for (var i = 0; i < arr.length; i++) {\n            var cur = [];\n            for (var j = 0; j < arr[0].length; j++) {\n                cur.push(new Cell({ x: arr[i][j][1], y: arr[i][j][0] }, { x: i, y: j }, cellTypeFromNumber(arr[i][j])));\n            }\n            newArr.push(cur);\n        }\n        return new World(newArr);\n    };\n    World.prototype.tick = function () {\n    };\n    World.prototype.getCell = function (pos) {\n        if (!this.isValid(pos))\n            throw new Error(\"Position not valid: \".concat(pos));\n        return this.map[pos.x][pos.y];\n    };\n    World.prototype.setCell = function (cell) {\n        this.map[cell.pos.x][cell.pos.y] = cell;\n    };\n    World.prototype.isValid = function (pos) {\n        return pos.x >= 0 && pos.x < this.map.length\n            && pos.y >= 0 && pos.y < this.map[0].length;\n    };\n    World.prototype.getSurroundingCells = function (cell, range, cellTypes) {\n        range = range == -1 ? Number.MAX_VALUE : range;\n        var result = [];\n        var seen = new Set();\n        var q = [];\n        q.push(cell.pos);\n        while (q.length > 0 && range > 0) {\n            var cur = [];\n            while (q.length > 0) {\n                var pos = q.pop();\n                if (!this.isValid(pos))\n                    continue;\n                if (seen.has(pos))\n                    continue;\n                seen.add(pos);\n                var cell_1 = this.getCell(pos);\n                if (cellTypes.size === 0 || cellTypes.has(cell_1.type))\n                    result.push(cell_1);\n                for (var _i = 0, _a = [\n                    { x: cell_1.pos.x - 1, y: cell_1.pos.y },\n                    { x: cell_1.pos.x + 1, y: cell_1.pos.y },\n                    { x: cell_1.pos.x, y: cell_1.pos.y - 1 },\n                    { x: cell_1.pos.x, y: cell_1.pos.y + 1 },\n                ]; _i < _a.length; _i++) {\n                    var child = _a[_i];\n                    if (!seen.has(child))\n                        cur.push(child);\n                }\n            }\n            q = cur;\n            range--;\n        }\n        return result;\n    };\n    return World;\n}());\nexports.World = World;\nvar Cell = (function () {\n    function Cell(texture, pos, type) {\n        this.texture = texture;\n        this.pos = pos;\n        this.type = type;\n    }\n    return Cell;\n}());\nexports.Cell = Cell;\nvar Building = (function (_super) {\n    __extends(Building, _super);\n    function Building() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    return Building;\n}(Cell));\nexports.Building = Building;\n\n\n//# sourceURL=webpack:///./src/game.ts?");

/***/ }),

/***/ "./src/index.ts":
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nexports.__esModule = true;\n__exportStar(__webpack_require__(/*! ./ui */ \"./src/ui.ts\"), exports);\n__exportStar(__webpack_require__(/*! ./main */ \"./src/main.ts\"), exports);\n__exportStar(__webpack_require__(/*! ./game */ \"./src/game.ts\"), exports);\n\n\n//# sourceURL=webpack:///./src/index.ts?");

/***/ }),

/***/ "./src/main.ts":
/*!*********************!*\
  !*** ./src/main.ts ***!
  \*********************/
/***/ ((__unused_webpack_module, exports, __webpack_require__) => {

eval("\nexports.__esModule = true;\nvar game_1 = __webpack_require__(/*! ./game */ \"./src/game.ts\");\nvar ui_1 = __webpack_require__(/*! ./ui */ \"./src/ui.ts\");\nvar $ = function (_) { return document.querySelector(_); };\nvar $c = function (_) { return document.createElement(_); };\nvar drawingContainer, canvas, bg, canvasFg, fg, tool, activeTool, isPlacing;\nvar viewCenter, scale = 1;\nvar mousePos = [0, 0];\nvar ntiles, tileWidth, tileHeight, texWidth, texHeight;\nvar world;\nvar ui = new ui_1.UI();\nvar mode = 'BUILD';\nvar texture = new Image();\ntexture.src = \"textures/bg.png\";\ntexture.onload = function (_) { return init(); };\nvar init = function () {\n    tool = [0, 0];\n    var map = [];\n    var k = 20;\n    console.log(\"Starting with k=\".concat(k));\n    for (var i = 0; i < k; i++) {\n        var cur = [];\n        for (var j = 0; j < k; j++) {\n            cur.push([0, 0]);\n        }\n        map.push(cur);\n    }\n    scale = 1;\n    viewCenter = { x: -650, y: -50 };\n    drawingContainer = $(\"#drawing-container\");\n    canvas = $(\"#bg\");\n    canvasFg = $('#fg');\n    bg = canvas.getContext(\"2d\");\n    fg = canvasFg.getContext('2d');\n    window.addEventListener('resize', resize);\n    ntiles = map.length;\n    tileWidth = 128;\n    tileHeight = 64;\n    texWidth = 12;\n    texHeight = 6;\n    loadHashState(map, document.location.hash.substring(1));\n    world = game_1.World.fromTextureArray(map);\n    resize();\n    canvasFg.addEventListener('mousemove', onHover);\n    canvasFg.addEventListener('contextmenu', function (e) { return e.preventDefault(); });\n    canvasFg.addEventListener('mouseup', unclick);\n    canvasFg.addEventListener('mousedown', onClick);\n    canvasFg.addEventListener(\"wheel\", onScroll);\n    addEventListener(\"keydown\", onKeyPress);\n    setInterval(tick, 1000 / 30);\n    renderTools();\n};\nfunction renderTools() {\n    var tools = $('#tools');\n    var toolCount = 0;\n    var _loop_1 = function (i) {\n        var _loop_2 = function (j) {\n            var div = $c('div');\n            div.id = \"tool_\".concat(toolCount++);\n            div.style.display = \"block\";\n            div.style.backgroundPosition = \"-\".concat(j * 130 + 2, \"px -\").concat(i * 230, \"px\");\n            div.addEventListener('click', function (e) {\n                tool = [i, j];\n                if (activeTool)\n                    $(\"#\".concat(activeTool)).classList.remove('selected');\n                activeTool = e.target.id;\n                $(\"#\".concat(activeTool)).classList.add('selected');\n            });\n            tools.appendChild(div);\n        };\n        for (var j = 0; j < texWidth; j++) {\n            _loop_2(j);\n        }\n    };\n    for (var i = 0; i < texHeight; i++) {\n        _loop_1(i);\n    }\n}\nfunction tick() {\n    drawMap();\n    drawCursor();\n    world.tick();\n}\nfunction resize() {\n    canvas.width = drawingContainer.offsetWidth;\n    canvas.height = drawingContainer.offsetHeight;\n    canvasFg.width = canvas.width;\n    canvasFg.height = canvas.height;\n}\nvar ToBase64 = function (u8) {\n    return btoa(String.fromCharCode.apply(null, u8));\n};\nvar FromBase64 = function (str) {\n    return atob(str).split('').map(function (c) { return c.charCodeAt(0); });\n};\nvar updateHashState = function () {\n    var c = 0;\n    var u8 = new Uint8Array(ntiles * ntiles);\n    for (var i = 0; i < ntiles; i++) {\n        for (var j = 0; j < ntiles; j++) {\n            u8[c++] = world.map[i][j].texture.y * texWidth + world.map[i][j].texture.x;\n        }\n    }\n    var state = ToBase64(u8);\n    history.replaceState(undefined, undefined, \"#\".concat(state));\n};\nvar loadHashState = function (map, state) {\n    var u8 = FromBase64(state);\n    var c = 0;\n    for (var i = 0; i < ntiles; i++) {\n        for (var j = 0; j < ntiles; j++) {\n            var t = u8[c++] || 0;\n            var x = Math.trunc(t / texWidth);\n            var y = Math.trunc(t % texWidth);\n            map[i][j] = [x, y];\n        }\n    }\n};\nfunction clearCtx(ctx) {\n    ctx.save();\n    ctx.setTransform(1, 0, 0, 1, 0, 0);\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    ctx.restore();\n}\nfunction drawMap() {\n    clearCtx(bg);\n    bg.save();\n    bg.scale(scale, scale);\n    for (var i = 0; i < ntiles; i++) {\n        for (var j = 0; j < ntiles; j++) {\n            drawImageTile(bg, i, j, world.map[i][j].texture.y, world.map[i][j].texture.x);\n        }\n    }\n    bg.restore();\n}\nfunction drawCursor() {\n    clearCtx(fg);\n    var color = 'rgba(0,0,0,0.2)';\n    if (mode === 'DETAILS') {\n        color = 'rgba(11,127,171,0.3)';\n    }\n    if (mousePos.x >= 0 && mousePos.x < ntiles && mousePos.y >= 0 && mousePos.y < ntiles) {\n        drawTile(fg, mousePos.x, mousePos.y, color);\n    }\n}\nvar drawTile = function (c, x, y, color) {\n    c.save();\n    c.scale(scale, scale);\n    c.translate((y - x) * tileWidth / 2 - viewCenter.x, (x + y) * tileHeight / 2 - viewCenter.y);\n    c.beginPath();\n    c.moveTo(0, 0);\n    c.lineTo(tileWidth / 2, tileHeight / 2);\n    c.lineTo(0, tileHeight);\n    c.lineTo(-tileWidth / 2, tileHeight / 2);\n    c.closePath();\n    c.fillStyle = color;\n    c.fill();\n    c.restore();\n};\nvar drawImageTile = function (c, x, y, i, j) {\n    c.save();\n    c.translate((y - x) * tileWidth / 2 - viewCenter.x, (x + y) * tileHeight / 2 - viewCenter.y);\n    j *= 130;\n    i *= 230;\n    c.drawImage(texture, j, i, 130, 230, -65, -130, 130, 230);\n    c.restore();\n};\nvar getTilePosition = function (e) {\n    var __x = e.offsetX / scale;\n    var __y = e.offsetY / scale;\n    var _y = (__y + viewCenter.y) / tileHeight;\n    var _x = (__x + viewCenter.x) / tileWidth;\n    var x = Math.floor(_y - _x);\n    var y = Math.floor(_x + _y);\n    return { x: x, y: y };\n};\nfunction onHover(e) {\n    mousePos = getTilePosition(e);\n}\nfunction onKeyPress(event) {\n    var delta = 100;\n    switch (event.keyCode) {\n        case 38:\n            viewCenter.y -= delta;\n            break;\n        case 40:\n            viewCenter.y += delta;\n            break;\n        case 37:\n            viewCenter.x -= delta;\n            break;\n        case 39:\n            viewCenter.x += delta;\n            break;\n    }\n}\nfunction onScroll(e) {\n    e.preventDefault();\n    var delta = 0.006;\n    if (e.deltaY < 0)\n        scale -= delta;\n    else if (e.deltaY > 0)\n        scale += delta;\n    if (scale > 1.3)\n        scale = 1.3;\n    if (scale < 0.5)\n        scale = 0.5;\n}\nvar onClick = function (e) {\n    var pos = getTilePosition(e);\n    if (!(pos.x >= 0 && pos.x < ntiles && pos.y >= 0 && pos.y < ntiles))\n        return;\n    if (mode === 'BUILD') {\n        world.setCell(new game_1.Cell({ x: tool[1], y: tool[0] }, pos, (0, game_1.cellTypeFromNumber)(tool)));\n        isPlacing = true;\n        updateHashState();\n        return;\n    }\n    if (mode === 'DETAILS') {\n        var cell = world.getCell(pos);\n        var cells = world.getSurroundingCells(cell, 2, new Set());\n        for (var _i = 0, cells_1 = cells; _i < cells_1.length; _i++) {\n            var c = cells_1[_i];\n            drawTile(fg, c.pos.x, c.pos.y, 'rgba(11, 127, 171,0.2)');\n        }\n        ui.infoTab.showCellInfo(cell, \"Cells around=[\".concat(cells.map(function (c) { return c.type.description; }).join(\", \"), \"]\"));\n        return;\n    }\n};\nvar unclick = function () {\n    isPlacing = false;\n};\nfunction activateTab(e) {\n    var selector = e.getAttribute(\"data-tab\");\n    for (var _i = 0, _a = $(\"#instruments\").children; _i < _a.length; _i++) {\n        var child = _a[_i];\n        child.style.display = \"none\";\n    }\n    for (var _b = 0, _c = $(\"#btns\").children; _b < _c.length; _b++) {\n        var child = _c[_b];\n        child.classList.remove(\"btn-dark\");\n        child.classList.add(\"btn-outline-dark\");\n    }\n    e.classList.remove(\"btn-outline-dark\");\n    e.classList.add(\"btn-dark\");\n    $(selector).style.display = \"flex\";\n    switch (selector) {\n        case \"#tools\":\n            mode = \"BUILD\";\n            break;\n        case \"#details\":\n            mode = \"DETAILS\";\n            break;\n    }\n}\nwindow.activateTab = activateTab;\n\n\n//# sourceURL=webpack:///./src/main.ts?");

/***/ }),

/***/ "./src/ui.ts":
/*!*******************!*\
  !*** ./src/ui.ts ***!
  \*******************/
/***/ ((__unused_webpack_module, exports) => {

eval("\nexports.__esModule = true;\nexports.UI = void 0;\nvar UI = (function () {\n    function UI() {\n        this.infoTab = new InfoTab();\n    }\n    return UI;\n}());\nexports.UI = UI;\nvar InfoTab = (function () {\n    function InfoTab() {\n        this.el = $(InfoTab.selector)[0];\n    }\n    InfoTab.prototype.showCellInfo = function (cell, info) {\n        this.el.innerHTML = \"\\n            <table class=\\\"table table-sm\\\">\\n                <tr>\\n                    <td>Type</td>\\n                    <td>\".concat(cell.type.description, \"</td>\\n                </tr>\\n                <tr>\\n                    <td>Position</td>\\n                    <td>\").concat(JSON.stringify(cell.pos), \"</td>\\n                </tr>\\n                <tr>\\n                    <td>Additional info</td>\\n                    <td>\").concat(info, \"</td>\\n                </tr>\\n            </table>\\n        \");\n    };\n    InfoTab.selector = \"#details\";\n    InfoTab.noContent = \"<p>Pick cell to inspect</p>\";\n    return InfoTab;\n}());\n\n\n//# sourceURL=webpack:///./src/ui.ts?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module is referenced by other modules so it can't be inlined
/******/ 	var __webpack_exports__ = __webpack_require__("./src/index.ts");
/******/ 	
/******/ })()
;